# Shared Middlewares - Used across all environments
# Reference these in your routes with @file suffix (e.g., default-security-headers@file)

http:
  middlewares:
    # Security Headers - Applied to all routes by default
    default-security-headers:
      headers:
        # HSTS - Force HTTPS for 1 year
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true
        # Prevent clickjacking
        frameDeny: true
        # Prevent MIME type sniffing
        contentTypeNosniff: true
        # XSS Protection
        browserXssFilter: true
        # Referrer Policy
        referrerPolicy: "strict-origin-when-cross-origin"
        # Content Security Policy - Basic policy, customize per project
        contentSecurityPolicy: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"
        # Additional security headers
        customResponseHeaders:
          X-Robots-Tag: "none"
          X-Download-Options: "noopen"
          X-Permitted-Cross-Domain-Policies: "none"

    # Response Compression - Enabled by default
    default-compression:
      compress:
        excludedContentTypes:
          - "image/jpeg"
          - "image/png"
          - "image/gif"
          - "image/webp"
          - "video/mp4"
          - "video/webm"
        minResponseBodyBytes: 1024

    # Default Rate Limiting - 100 req/s per IP, burst 200
    default-ratelimit:
      rateLimit:
        average: 100
        burst: 200
        period: 1s
        sourceCriterion:
          ipStrategy:
            depth: 1

    # Circuit Breaker - Reusable circuit breaker configuration
    # Opens circuit if 30% of requests fail (network errors or 5xx responses)
    # Stays open for 30s (returns 503 immediately)
    # After 30s, allows test requests to check if backend recovered
    default-circuit-breaker:
      circuitBreaker:
        expression: "NetworkErrorRatio() > 0.30 || ResponseCodeRatio(500, 600, 0, 600) > 0.30"
        checkPeriod: 10s
        fallbackDuration: 30s
        recoveryDuration: 30s

    # IP Whitelist - Internal Services Only
    # Use for: Admin panels, monitoring endpoints
    # Only allows access from Docker/private networks (blocks public internet)
    internal-only:
      ipWhiteList:
        sourceRange:
          - "172.16.0.0/12"    # Docker networks
          - "10.0.0.0/8"       # Private networks
          - "192.168.0.0/16"   # Private networks
          - "127.0.0.1/32"     # Localhost

    # IP Whitelist - Cloudflare Only
    # PRODUCTION SECURITY: Prevents direct server IP access
    # Only allows traffic from Cloudflare IPs (blocks direct server access)
    # UPDATE: Cloudflare IPs change occasionally - update from https://www.cloudflare.com/ips/
    cloudflare-only:
      ipWhiteList:
        sourceRange:
          # Cloudflare IPv4 ranges (last updated: 2024)
          - "173.245.48.0/20"
          - "103.21.244.0/22"
          - "103.22.200.0/22"
          - "103.31.4.0/22"
          - "141.101.64.0/18"
          - "108.162.192.0/18"
          - "190.93.240.0/20"
          - "188.114.96.0/20"
          - "197.234.240.0/22"
          - "198.41.128.0/17"
          - "162.158.0.0/15"
          - "104.16.0.0/13"
          - "104.24.0.0/14"
          - "172.64.0.0/13"
          - "131.0.72.0/22"
          # Cloudflare IPv6 ranges
          - "2400:cb00::/32"
          - "2606:4700::/32"
          - "2803:f800::/32"
          - "2405:b500::/32"
          - "2405:8100::/32"
          - "2a06:98c0::/29"
          - "2c0f:f248::/32"
